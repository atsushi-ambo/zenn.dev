---
title: "AWS CloudWatchのコスト分析: CURとAthenaを使用した詳細レポート作成"
emoji: "📊"
type: "tech"
topics: ["aws", "cloudwatch", "athena", "cost"]
published: false
description: "AWS CloudWatchのコストを最大70%削減する方法を解説。Cost and Usage Reports (CUR)とAthenaを使用した詳細な分析方法と、即効性のある最適化施策を紹介します。メトリクス、ログ、アラームのコスト管理について具体的な削減手法を解説。"
---

# AWS CloudWatchのコストを詳細に分析する

CloudWatchは、AWSリソースとアプリケーションのモニタリングに不可欠なサービスですが、適切な管理をしないとコストが急増する可能性があります。以下のような要因が主な原因となります：

- 複数のAWSサービスからの大量のログデータ（数GB～数TB）
- 頻繁なメトリクス更新（秒単位での収集）
- 多数のカスタムメトリクスやアラームの設定（数百～数千単位）
- 長期のデータ保持設定（数ヶ月～数年）

本記事では、AWS Cost and Usage Reports (CUR)とAthenaを使用して、CloudWatchのコストを詳細に分析し、最適化する方法を解説します。以下の内容を学ぶことができます：

- 📊 コスト構造の詳細な理解と可視化手法
- 🔍 具体的な無駄の特定方法
- ⚡ 即効性のある最適化施策（10-70%のコスト削減可能）
- 📈 長期的なコスト管理戦略

CURデータの準備中でも実施できる即時の改善策から、データが揃った後の詳細分析まで、段階的に実践できる形で解説していきます。

## CloudWatchのコスト構造と分析の重要性

### CloudWatchの主要コスト要素と料金体系

CloudWatchは以下の主要機能ごとに異なる課金体系を持っています：

1. **メトリクス**
   - カスタムメトリクスの数（1メトリクス/月あたりの料金）
   - API呼び出しの頻度（GetMetricData, PutMetricData等）
   - データポイントの保存期間（15ヶ月まで無料）
   - 高解像度メトリクス（1秒間隔）は追加料金

2. **ログ**
   - 取り込みデータ量（GB単位で課金）
   - ストレージ容量（GB/月単位で課金）
   - 分析のためのCloudWatch Logs Insightsクエリ（GB単位で課金）
   - ログデータの保存期間（長期保存は追加コスト）

3. **アラーム**
   - 標準解像度（60秒間隔）のアラーム数
   - 高解像度（10秒または30秒間隔）のアラーム数
   - 複合アラーム数
   - メトリクスアラームの評価回数

4. **ダッシュボード**
   - ダッシュボード数（1ダッシュボード/月あたりの料金）
   - API呼び出し頻度
   - ウィジェット数（料金への影響なし）

### なぜ詳細な分析が重要か？

以下のような状況で、コストが予期せず増加する可能性があります：

1. **ログ関連**
   - 不必要に詳細なログレベル
   - 長すぎるログ保持期間
   - デバッグログの本番環境での有効化

2. **メトリクス関連**
   - 未使用のカスタムメトリクス
   - 過度に頻繁なデータ収集
   - 不要な高解像度メトリクス

3. **アラーム関連**
   - 不要な高解像度アラーム
   - 過剰なアラーム評価頻度

このような状況を早期に発見し、対処するために、詳細なコスト分析は以下の点で重要です：

- リソースごとの使用量とコストの明確な把握
- 異常なコスト増加の早期発見
- コスト最適化機会の特定と優先順位付け

## Cost and Usage Reports (CUR)の設定

AWS CURは、AWSの使用状況とコストの最も詳細なレポートを提供します。以下の手順で設定を行います：

### 1. レポート作成の開始

1. AWSマネジメントコンソールにログインし、右上のアカウント名をクリック
2. 「Billing Dashboard」を選択
3. 左メニューから「Cost & Usage Reports」を選択
4. 「Create report」をクリック

### 2. レポートの設定

レポート設定では以下の項目を指定します：

1. **Report name（レポート名）**:
   - わかりやすい名前を設定（例：`cloudwatch-cost-analysis`）
   - このレポート名は後でAthenaのテーブル作成時にも使用

2. **追加設定オプション**:
   - Include resource IDs: `True`（リソースごとの詳細分析が可能に）
   - Data refresh settings: `Automatically refresh`（データの自動更新を有効化）
   - Time granularity: `Hourly`（1時間単位での詳細なデータ取得）

### 3. S3バケットの設定

レポートデータの保存先となるS3バケットの設定:

1. **新規バケットの作成または既存バケットの選択**
2. **レポートパスプレフィックスの設定**（例：`cur/cloudwatch/`）
3. **データ圧縮形式**: Parquet形式を推奨（Athenaでの分析に最適）

### 4. Athenaの統合設定

CURデータをAthenaで分析するための準備:

1. **マニフェストの作成を有効化**
2. **Athenaと互換性のある形式を選択**
   - Parquet形式
   - 時間単位のデータ保存

※ 現在、レポートデータのS3バケットへのエクスポートを待っている状態です。

### CURデータ待機中の施策

CURのデータエクスポートを待つ間、以下の基本的な監視と最適化を実施できます：

#### 1. 基本的なコスト監視

1. **AWS Cost Explorer**
   - サービス別のコスト概要確認
   - 日次レベルでの使用量トレンド把握
   - 基本的な使用パターンの特定

2. **CloudWatch Metrics**
   - `AWS/Usage` と `AWS/Billing` メトリクスの確認
   - アカウントレベルの使用量モニタリング
   - 基本的なアラートの設定

#### 2. 即時実施可能な最適化策

1. **ログ関連の最適化**
   - 不要なログレベルの調整（DEBUG → INFO等）
   - 古いログの削除やアーカイブ設定
   - ログ保持期間の見直し（例：1年→3ヶ月）

2. **メトリクス関連の最適化**
   - 未使用のカスタムメトリクスの特定と削除
   - 収集頻度の見直し（高解像度が不要な場合は標準解像度へ）
   - 不要なメトリクスフィルターの削除

3. **アラーム関連の最適化**
   - 未使用アラームの特定と削除
   - アラーム評価期間の見直し
   - 高解像度アラームの必要性確認

4. **ダッシュボード関連の最適化**
   - 未使用ダッシュボードの削除
   - 更新頻度の適正化
   - ウィジェット数の最適化

#### 3. 主な最適化による削減効果例

以下は、一般的な最適化施策による概算の削減効果です：

1. **ログ関連**
   - ログレベル最適化：10-30%削減
   - 保持期間短縮（1年→3ヶ月）：50-70%削減
   - 不要なログの削除：5-15%削減

2. **メトリクス関連**
   - 未使用メトリクス削除：10-20%削減
   - 収集頻度最適化：20-40%削減
   - 高解像度→標準解像度：40-60%削減

3. **アラーム関連**
   - 未使用アラーム削除：5-15%削減
   - 評価頻度最適化：10-30%削減
   - 高解像度アラーム見直し：30-50%削減

※ これらの数値は一般的な例であり、実際の削減効果は利用状況により異なります。

これらの基本的な最適化を行いながら、CURデータが揃い次第、以下の詳細分析を実施していきます：

## 今後の予定：Athenaを使用したデータ分析

データがS3にエクスポートされたら、以下の分析を段階的に実施していきます：

### 1. Athenaテーブルのセットアップ
- CURデータ用のデータベース作成
- Parquetフォーマットに対応したテーブルスキーマの定義
- パーティション設定による効率的なクエリ実行

### 2. CloudWatch機能別コスト分析
以下の項目ごとのコスト集計と傾向分析を行います：

1. **メトリクス分析**
   - カスタムメトリクスの利用状況
   - API呼び出し頻度の分布
   - 高コストのメトリクス特定

2. **ログ分析**
   - ログストレージ使用量の推移
   - ロググループごとのコスト比較
   - 高額なログ取り込みの特定

3. **アラーム分析**
   - 高解像度アラームのコスト影響
   - アラーム評価頻度の分析
   - 未使用アラームの特定

### 3. リソース最適化の分析
以下の観点で最適化機会を分析します：

- 未使用リソースの特定
- コストトレンドの異常検出
- リソースタグベースのコスト配分
- 費用対効果の低いリソースの特定

### 4. SQLクエリ例の提供
主要な分析クエリのテンプレートを提供予定：

- 機能別コスト集計クエリ
- 時系列での使用量推移クエリ
- リソースごとのコスト比較クエリ
- 異常検知用クエリ

## 今後の更新予定

本記事は以下の内容を順次追加していく予定です：

1. **CUR設定手順のスクリーンショット**
   - AWSコンソールでの具体的な設定画面
   - 各設定項目の選択例

2. **Athenaでの分析例**
   - 実際のCURデータを使用した分析結果
   - コスト分析用SQLクエリ集
   - クエリ結果の可視化例

Stay tuned for updates!

## 参考文献

- [AWS Cost and Usage Reports ユーザーガイド](http://docs.aws.amazon.com/cur/latest/userguide/cur-create.html)
- [AWS CUR & Athenaによるコスト分析事例](https://zenn.dev/dehio3/articles/816d9d82c331d4)
